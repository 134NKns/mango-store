<div class="p-3">
  <div class="flex justify-content-center align-items-center mb-4 gap-3">
    <span class="p-input-icon-left w-50">
      <i class="pi pi-search"></i>
      <input 
        type="text" 
        pInputText 
        [(ngModel)]="searchValue" 
        (input)="onSearchInputChange()"
        placeholder="ค้นหาสินค้า"
        class="w-full"
      />
    </span>
    <button pButton type="button" icon="pi pi-refresh" class="p-button-outlined" (click)="refreshProducts()"></button>
  </div>

  <div *ngIf="products.length === 0" class="flex justify-content-center align-items-center no-products">
    ไม่พบสินค้า
  </div>

  <div *ngIf="products.length > 0" class="grid">
    <div *ngFor="let product of displayedProducts" class="col-12 sm:col-6 md:col-4 lg:col-3 p-2">
      <p-card [header]="product.name" class="product-card h-full">
        <ng-template pTemplate="header">
          <div class="image-wrapper">
            <p-image 
              [src]="product.images[0]?.image_data || '../../assets/images/no-image.png'" 
              alt="Card" 
              [preview]="true">
            </p-image>
          </div>
        </ng-template>
        <div class="flex justify-content-between align-items-center mt-2">
          <h3 class="text-right m-0">{{product.price}} บาท</h3>
        </div>
        <ng-template pTemplate="footer">
          <div class="flex flex-column gap-3 mt-1 w-full">
            <p-button 
              label="รายละเอียดสินค้า" 
              icon="pi pi-info-circle" 
              severity="info" 
              [style]="{ width: '100%' }" 
              class="w-full p-button-sm text-sm" 
              (click)="showProductDetails(product)"
            />
            <p-button 
              label="เพิ่มเข้าตะกร้า" 
              icon="pi pi-shopping-cart" 
              severity="success" 
              [style]="{ width: '100%' }" 
              class="w-full p-button-sm text-sm" 
              (click)="addToCart(product)"
            />
          </div>                      
        </ng-template>
      </p-card>
    </div>
  </div>
  <p-paginator 
    *ngIf="products.length > 0" 
    [rows]="productsPerPage" 
    [totalRecords]="products.length" 
    (onPageChange)="onPageChange($event)" 
    class="mt-4">
  </p-paginator>

  <p-dialog header="รายละเอียดสินค้า" [(visible)]="displayDialog" [modal]="true" [closable]="true" [responsive]="true" [breakpoints]="{'960px': '75vw', '640px': '90vw'}" [style]="{width: '40vw'}">
    <ng-template pTemplate="content">
      <div *ngIf="selectedProduct">
        <h2>{{ selectedProduct.name }}</h2>
        <div *ngFor="let image of selectedProduct.images" class="flex justify-content-center mb-2">
          <p-image [src]="image.image_data" alt="Product Image" width="400" [preview]="true"></p-image>
        </div>
        <h3>{{ selectedProduct.price }} บาท</h3>
        <p>{{ selectedProduct.description }}</p>
      </div>
    </ng-template>
    <ng-template pTemplate="footer">
      <p-button label="Close" icon="pi pi-times" (click)="displayDialog = false"></p-button>
    </ng-template>
  </p-dialog>

  <p-dialog header="กรุณาล็อกอิน" [(visible)]="displayLoginDialog" [modal]="true" [closable]="true" [responsive]="true" [breakpoints]="{'960px': '75vw', '640px': '90vw'}" [style]="{width: '30vw'}">
    <ng-template pTemplate="content">
      <p>กรุณาล็อกอินหรือสมัครสมาชิกก่อนทำการเพิ่มสินค้าลงในตะกร้า</p>
    </ng-template>
    <ng-template pTemplate="footer">
      <p-button label="Close" icon="pi pi-times" (click)="displayLoginDialog = false"></p-button>
    </ng-template>
  </p-dialog>

  <p-dialog header="เพิ่มสินค้าลงในตะกร้า" [(visible)]="displayAddToCartDialog" [modal]="true" [closable]="true" [responsive]="true" [breakpoints]="{'960px': '75vw', '640px': '90vw'}" [style]="{width: '30vw'}">
    <ng-template pTemplate="content">
      <div *ngIf="selectedProduct" class="p-fluid">
        <div class="p-d-flex p-flex-column p-ai-center">
          <div class="image-container" [style]="{width: '100%', maxHeight: '300px', overflow: 'hidden'}">
            <p-image 
              [src]="selectedProduct.images[0]?.image_data || '../../assets/images/no-image.png'" 
              alt="Product Image" 
              [style]="{width: '100%', height: '100%', objectFit: 'contain'}">
            </p-image>
          </div>
          <h3 class="p-mt-2 p-text-center" [style]="{ 'font-size': '1.2em' }">{{ selectedProduct.name }}</h3>
          <h4 class="p-mt-1">{{ selectedProduct.price }} บาท</h4>
          <p>กรุณาระบุจำนวนที่ต้องการเพิ่มลงในตะกร้า (มีสินค้าคงเหลือ: {{ selectedProduct.stock }})</p>
          <p-inputNumber 
            [(ngModel)]="quantity" 
            mode="decimal" 
            [showButtons]="true" 
            inputId="minmax-buttons" 
            [min]="1" 
            [max]="selectedProduct.stock" 
            class="w-full" 
            [style]="{ width: '100%' }">
          </p-inputNumber>
          <p>กรุณาระบุที่อยู่จัดส่ง:</p>
          <input type="text" pInputText [(ngModel)]="shippingAddress" class="w-full" [style]="{ width: '100%' }"/>
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="footer">
      <div class="p-d-flex p-jc-end">
        <p-button label="ยืนยัน" icon="pi pi-check" class="p-mr-2" (click)="confirmAddToCart()"></p-button>
        <p-button label="ยกเลิก" icon="pi pi-times" (click)="displayAddToCartDialog = false" severity="danger"></p-button>
      </div>
    </ng-template>
  </p-dialog>
</div>
